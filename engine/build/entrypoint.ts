import * as path from "std/path/mod.ts";
import { Registry } from "../registry/mod.ts";
import * as tjs from "typescript-json-schema";

export async function generateEntrypoint(registry: Registry) {
    let outDir = path.join(registry.path, 'dist');
    let outPath = path.join(outDir, 'entrypoint.ts');

    // Generate module configs
    let modImports = "";
    let modConfig = "{";
    for (let mod of registry.modules.values()) {
        modConfig += `${JSON.stringify(mod.name)}: {`;

        // Generate script configs
        modConfig += "scripts: {";
        for (let script of mod.scripts.values()) {
            let handlerIdent = `modules__${mod.name}__${script.name}__handler`;

            modImports += `import { handler as ${handlerIdent} } from '../modules/${mod.name}/scripts/${script.name}.ts';\n`;
            modConfig += `${JSON.stringify(script.name)}: { handler: ${handlerIdent}, requestSchema: ${JSON.stringify(script.requestSchema)}, responseSchema: ${JSON.stringify(script.responseSchema)} },`;
        }
        modConfig += "},";

        modConfig += "},";
    }
    modConfig += "}";

    // Generate source
    let source = `
// This file is generated by @ogs/engine-builder

import { Runtime } from "@ogs/runtime";

${modImports}

async function main() {
    let runtime = new Runtime({
        modules: ${modConfig},
    });
    await runtime.serve();
}

main();

`;

    // Write file
    console.log('Writing entrypoint', outPath);
    await Deno.mkdir(outDir, {recursive: true});
    await Deno.writeTextFile(outPath, source);
}

